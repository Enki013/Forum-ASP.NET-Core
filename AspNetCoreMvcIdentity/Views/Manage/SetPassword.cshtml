@model SetPasswordViewModel
@{
    ViewData["Title"] = "Set password";
    ViewData.AddActivePage(ManageNavPages.ChangePassword);
}

<style>
    .validation-list {
        list-style: none;
        padding: 0;
        margin: 5px 0 10px 0;
        font-size: 0.85em;
        display: none;
    }
    .validation-list.show {
        display: block;
    }
    .validation-list li {
        padding: 2px 0;
    }
    .validation-list li i {
        margin-right: 5px;
        width: 16px;
    }
    .valid {
        color: #28a745;
    }
    .invalid {
        color: #dc3545;
    }
</style>

<h4>Set your password</h4>
@Html.Partial("_StatusMessage", Model.StatusMessage)
<p class="text-info">
    You do not have a local username/password for this site. Add a local
    account so you can log in without an external login.
</p>
<div class="row">
    <div class="col-md-6">
        <form method="post">
            <div asp-validation-summary="All" class="text-danger"></div>
            <div class="form-group">
                <label asp-for="NewPassword"></label>
                <div class="input-group">
                    <input asp-for="NewPassword" class="form-control" oninput="validatePassword()" />
                    <span class="input-group-text" style="cursor: pointer;" onclick="togglePassword('NewPassword', this)">
                        <i class="fa fa-eye"></i>
                    </span>
                </div>
                <ul class="validation-list" id="passwordValidation">
                    <li id="pwLength"><i class="fa fa-times invalid"></i> En az 6 karakter</li>
                    <li id="pwLower"><i class="fa fa-times invalid"></i> En az 1 küçük harf (a-z)</li>
                    <li id="pwUpper"><i class="fa fa-times invalid"></i> En az 1 büyük harf (A-Z)</li>
                    <li id="pwDigit"><i class="fa fa-times invalid"></i> En az 1 rakam (0-9)</li>
                    <li id="pwSpecial"><i class="fa fa-times invalid"></i> En az 1 özel karakter</li>
                </ul>
                <span asp-validation-for="NewPassword" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="ConfirmPassword"></label>
                <div class="input-group">
                    <input asp-for="ConfirmPassword" class="form-control" oninput="validateConfirmPassword()" />
                    <span class="input-group-text" style="cursor: pointer;" onclick="togglePassword('ConfirmPassword', this)">
                        <i class="fa fa-eye"></i>
                    </span>
                </div>
                <ul class="validation-list" id="confirmPasswordValidation">
                    <li id="pwMatch"><i class="fa fa-times invalid"></i> Şifreler eşleşiyor</li>
                </ul>
                <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
            </div>
            <button type="submit" class="btn btn-default">Set password</button>
        </form>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script>
        function togglePassword(inputId, toggleBtn) {
            var input = document.getElementById(inputId);
            var icon = toggleBtn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function showValidation(validationListId) {
            var list = document.getElementById(validationListId);
            if (list) {
                list.classList.add('show');
            }
        }

        function hideValidation(validationListId) {
            var list = document.getElementById(validationListId);
            if (list) {
                list.classList.remove('show');
            }
        }

        function setValid(elementId, isValid) {
            var element = document.getElementById(elementId);
            var icon = element.querySelector('i');
            if (isValid) {
                icon.classList.remove('fa-times', 'invalid');
                icon.classList.add('fa-check', 'valid');
                element.classList.remove('invalid');
                element.classList.add('valid');
            } else {
                icon.classList.remove('fa-check', 'valid');
                icon.classList.add('fa-times', 'invalid');
                element.classList.remove('valid');
                element.classList.add('invalid');
            }
        }

        function validatePassword() {
            var password = document.getElementById('NewPassword').value;
            if (password.length === 0) {
                hideValidation('passwordValidation');
                validateConfirmPassword();
                return;
            }
            showValidation('passwordValidation');
            
            setValid('pwLength', password.length >= 6);
            setValid('pwLower', /[a-z]/.test(password));
            setValid('pwUpper', /[A-Z]/.test(password));
            setValid('pwDigit', /[0-9]/.test(password));
            setValid('pwSpecial', /[^a-zA-Z0-9\s]/.test(password));
            
            validateConfirmPassword();
        }

        function validateConfirmPassword() {
            var password = document.getElementById('NewPassword').value;
            var confirmPassword = document.getElementById('ConfirmPassword').value;
            if (confirmPassword.length === 0) {
                hideValidation('confirmPasswordValidation');
                return;
            }
            showValidation('confirmPasswordValidation');
            setValid('pwMatch', password !== '' && password === confirmPassword);
        }
    </script>
}
